<div class="ai-analyze-container">
  <!-- Step 1: File Upload -->
  <div *ngIf="currentStep === 1" class="upload-section">
    <div class="upload-card">
      <div class="upload-header">
        <h2 *ngIf="!isTrialMode">Análise AI de Segurança</h2>
        <h2 *ngIf="isTrialMode">Teste Grátis - Análise AI</h2>
        <p *ngIf="isTrialMode" class="trial-notice">
          🎉 Teste grátis sem registo! Analisa 1 foto e vê o que o nosso AI detecta.
        </p>
      </div>

      <div class="upload-area" 
           (dragover)="$event.preventDefault()" 
           (drop)="onFileDrop($event)"
           [class.has-file]="selectedFile">
        
        <div *ngIf="!selectedFile" class="upload-placeholder">
          <div class="upload-icon">📸</div>
          <h3>{{ 'UPLOAD_IMAGE' | translate }}</h3>
          <p>O nosso AI vai analisar automaticamente a segurança no trabalho</p>
          <input type="file" 
                 #fileInput 
                 (change)="onFileSelected($event)" 
                 accept="image/*" 
                 class="file-input">
          <button class="upload-btn" (click)="fileInput.click()">
            Escolher Ficheiro
          </button>
        </div>

        <div *ngIf="selectedFile" class="file-preview">
          <img [src]="imagePreview" alt="Preview" class="preview-image">
          <div class="file-info">
            <p class="file-name">{{ selectedFile.name }}</p>
            <p class="file-size">{{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB</p>
          </div>
          <button class="analyze-btn" (click)="startAnalysis()" [disabled]="isAnalyzing">
            <span *ngIf="!isAnalyzing">{{ 'ANALYZE' | translate }}</span>
            <span *ngIf="isAnalyzing">⏳ A analisar...</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Analysis Progress -->
  <div *ngIf="currentStep === 2" class="analysis-section">
    <div class="analysis-card">
      <div class="analysis-header">
        <h2>🤖 Análise AI em Progresso</h2>
        <p>O nosso AI está a analisar a tua imagem...</p>
      </div>

      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="uploadProgress"></div>
        </div>
        <p class="progress-text">{{ uploadProgress }}% completo</p>
      </div>

      <div class="analysis-steps">
        <div class="step" [class.active]="uploadProgress >= 25">
          <span class="step-icon">📤</span>
          <span class="step-text">Upload da imagem</span>
        </div>
        <div class="step" [class.active]="uploadProgress >= 50">
          <span class="step-icon">🧠</span>
          <span class="step-text">Análise AI</span>
        </div>
        <div class="step" [class.active]="uploadProgress >= 75">
          <span class="step-icon">📄</span>
          <span class="step-text">Geração do relatório</span>
        </div>
        <div class="step" [class.active]="uploadProgress >= 100">
          <span class="step-icon">✅</span>
          <span class="step-text">Concluído</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 3: Results -->
  <div *ngIf="currentStep === 3 && analysisResult" class="results-section">
    <div class="results-card">
      <div class="results-header">
        <h2>🎯 Resultados da Análise AI</h2>
        <p>Análise completa da segurança no trabalho</p>
      </div>

      <!-- Compliance Score -->
      <div class="score-section">
        <div class="score-circle">
          <div class="score-number">{{ analysisResult.compliance.score }}%</div>
          <div class="score-label">Compliance</div>
        </div>
        <div class="score-details">
          <h3>Pontuação de Segurança</h3>
          <p>Baseado na análise AI da tua imagem</p>
        </div>
      </div>

      <!-- Risk Level -->
      <div class="risk-section">
        <h3>{{ 'RISK_LEVEL' | translate }}</h3>
        <div class="risk-indicator" [class]="'risk-' + analysisResult.risk.level">
          <span class="risk-level">{{ analysisResult.risk.level.toUpperCase() }}</span>
        </div>
      </div>

      <!-- Issues -->
      <div class="issues-section">
        <h3>⚠️ Problemas Identificados</h3>
        <ul class="issues-list">
          <li *ngFor="let issue of analysisResult.compliance.issues">{{ issue }}</li>
        </ul>
      </div>

      <!-- Recommendations -->
      <div class="recommendations-section">
        <h3>✅ Recomendações</h3>
        <ul class="recommendations-list">
          <li *ngFor="let rec of analysisResult.compliance.recommendations">{{ rec }}</li>
        </ul>
      </div>

      <!-- Legal Violations -->
      <div class="legal-section">
        <h3>⚖️ {{ 'LAW_BROKEN' | translate }}</h3>
        <ul class="legal-list">
          <li *ngFor="let violation of analysisResult.legal.violations">{{ violation }}</li>
        </ul>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="download-btn" (click)="downloadPDF()">
          📄 {{ 'DOWNLOAD_PDF' | translate }}
        </button>
        
        <button *ngIf="!isTrialMode" class="dashboard-btn" (click)="goToDashboard()">
          📊 Ir para Dashboard
        </button>
        
        <button *ngIf="!isTrialMode" class="analyze-another-btn" (click)="analyzeAnother()">
          🔄 Analisar Outra Foto
        </button>
      </div>
    </div>

    <!-- Signup CTA for Trial Mode -->
    <div *ngIf="isTrialMode && showSignupCTA" class="signup-cta">
      <div class="cta-card">
        <div class="cta-header">
          <h2>🚀 Queres mais análises?</h2>
          <p>Desbloqueia o poder completo do nosso AI</p>
        </div>

        <div class="features-grid">
          <div class="feature">
            <span class="feature-icon">🧠</span>
            <h4>+20 Análises com IA</h4>
            <p>Análises ilimitadas com AI avançado</p>
          </div>
          <div class="feature">
            <span class="feature-icon">📸</span>
            <h4>Upload em Lote</h4>
            <p>Analisa múltiplas fotos de uma vez</p>
          </div>
          <div class="feature">
            <span class="feature-icon">📊</span>
            <h4>Dashboards Personalizados</h4>
            <p>Estatísticas por projeto e obra</p>
          </div>
          <div class="feature">
            <span class="feature-icon">📤</span>
            <h4>Relatórios Profissionais</h4>
            <p>Exportação PDF e envio automático</p>
          </div>
          <div class="feature">
            <span class="feature-icon">💬</span>
            <h4>Suporte Técnico</h4>
            <p>Auditorias remotas com IA</p>
          </div>
          <div class="feature">
            <span class="feature-icon">🔒</span>
            <h4>Segurança Total</h4>
            <p>Dados protegidos e privados</p>
          </div>
        </div>

        <div class="cta-buttons">
          <button class="signup-btn primary" (click)="goToSignup()">
            🎯 {{ 'CREATE_ACCOUNT' | translate }}
          </button>
          <button class="pricing-btn secondary" (click)="goToPricing()">
            💰 Ver Preços
          </button>
        </div>

        <p class="cta-footer">
          ✨ Não exigimos cartão. Primeira análise profissional é por nossa conta.
        </p>
      </div>
    </div>
  </div>
</div>
